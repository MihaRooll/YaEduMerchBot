# FSM для пользовательского сценария заказа

## Обзор
Реализован полный FSM (Finite State Machine) для создания заказов мерча с использованием pyTelegramBotAPI и JSON-хранилища.

## Состояния FSM

### 1. Start
- **Описание**: Начальное состояние, показывает приветствие и кнопку "Сделать заказ"
- **Переход**: `order_start` → PickSize
- **Возврат**: `order_back_to_start` → Главное меню

### 2. PickSize
- **Описание**: Выбор размера с отображением доступного количества
- **Переход**: `size_<size>` → PickColor (если есть цвета) или AwaitImage
- **Возврат**: `order_back_to_start` → Главное меню

### 3. PickColor (опционально)
- **Описание**: Выбор цвета для выбранного размера
- **Переход**: `color_<color>_<size>` → AwaitImage
- **Возврат**: `order_back_to_start` → Главное меню

### 4. AwaitImage
- **Описание**: Ожидание загрузки фотографии
- **Переход**: Загрузка фото → Review
- **Возврат**: `order_back_to_start` → Главное меню

### 5. Review
- **Описание**: Предпросмотр заказа с возможностью изменения
- **Переход**: 
  - `order_change_size` → PickSize
  - `order_change_photo` → AwaitImage
  - `order_select_chats` → PickChats
- **Возврат**: `order_back_to_start` → Главное меню

### 6. PickChats
- **Описание**: Выбор чатов для отправки заказа
- **Переход**: `chats_selected` → Confirm
- **Возврат**: `order_back_to_start` → Главное меню

### 7. Confirm
- **Описание**: Финальное подтверждение заказа
- **Переход**: `order_final_confirm` → Создание заказа
- **Возврат**: `order_back_to_start` → Главное меню

## Файлы реализации

### 1. `src/handlers/merch.py`
Основной файл с FSM хэндлерами:
- Определение состояний `OrderStates`
- Регистрация всех хэндлеров
- Вспомогательные функции для отображения экранов
- Логика создания заказа

### 2. `src/keyboards.py`
Обновленные клавиатуры:
- `get_order_review_keyboard()` - для предпросмотра заказа
- Обновленные callback_data для совместимости с FSM

### 3. `src/bot.py`
Интеграция FSM:
- Импорт и регистрация хэндлеров мерча
- Обновление callback'ов для перенаправления на FSM

## Особенности реализации

### Проверка прав пользователя
- Админы, координаторы, промо: неограниченное количество заказов
- Обычные пользователи: максимум 1 заказ

### Умная навигация
- Автоматический пропуск выбора цвета, если цветов нет
- Отображение доступного количества товаров
- Возможность изменения параметров на любом этапе

### Интеграция с существующей системой
- Использование существующего storage API
- Совместимость с существующими ролями пользователей
- Минимальные изменения в основной архитектуре

## Использование

### Для пользователей
1. Нажать "Создать заказ" в главном меню
2. Выбрать размер
3. Выбрать цвет (если доступен)
4. Загрузить фото
5. Просмотреть и при необходимости изменить
6. Выбрать чаты для отправки
7. Подтвердить заказ

### Для разработчиков
1. Все состояния определены в `OrderStates`
2. Хэндлеры регистрируются через `register_merch_handlers()`
3. Данные заказа хранятся во временном словаре `order_data`
4. Возможность расширения функциональности через добавление новых состояний

## Следующие шаги
- Реализация отправки заказов в чаты
- Добавление резервирования товаров
- Интеграция с системой уведомлений
- Добавление статусов заказов
