# Краткая сводка архитектуры YaEduMerchBot

## 🏗️ Архитектурная схема

```
┌─────────────────────────────────────────────────────────────┐
│                    Telegram API                            │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                    Docker Container                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                 YaEduMerchBot                       │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │   │
│  │  │   main.py   │ │  config.py  │ │   bot.py    │   │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘   │   │
│  │                                                     │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │   │
│  │  │    auth     │ │   storage   │ │chat_manager │   │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘   │   │
│  │                                                     │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │   │
│  │  │merch_manager│ │  handlers/  │ │keyboards.py │   │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘   │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│                    Data Layer                              │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐         │
│  │ users.json  │ │chats.json  │ │inventory.json│         │
│  └─────────────┘ └─────────────┘ └─────────────┘         │
│  ┌─────────────┐ ┌─────────────┐                         │
│  │orders.json  │ │  meta.json  │                         │
│  └─────────────┘ └─────────────┘                         │
└─────────────────────────────────────────────────────────────┘
```

## 🔑 Ключевые компоненты

### 1. **Основной бот** (`src/bot.py`)
- Центральный координатор всех операций
- Регистрация обработчиков
- Проверка готовности проекта

### 2. **Система ролей** (`src/auth.py`)
- **Admin** → **Coordinator** → **Promo** → **User**
- Иерархическая проверка прав
- Управление пользователями

### 3. **Хранилище данных** (`src/storage.py`)
- JSON-файлы для персистентности
- Атомарные операции записи
- Автоматическая инициализация

### 4. **Управление мерчем** (`src/merch_manager.py`)
- Каталог товаров
- Управление остатками
- Валидация данных

### 5. **FSM для заказов** (`src/handlers/merch.py`)
- 7 состояний заказа
- Пошаговое создание
- Валидация на каждом этапе

## 🐳 Docker особенности

### **Архитектура контейнера**
- **Базовый образ:** `python:3.11-slim`
- **Размер:** ~460MB
- **Порты:** Нет (long polling)
- **Volumes:** `bot_data:/app/data`, `./logs:/app/logs`

### **Переменные окружения**
```bash
BOT_TOKEN=your_token          # Обязательно
MAIN_ADMIN_ID=123456789       # Обязательно
LOG_LEVEL=INFO                # Опционально
DEBUG=False                   # Опционально
```

### **Сетевая модель**
- **Long Polling** → Telegram API
- **Нет внешних портов**
- **Полная изоляция**

## 📊 Характеристики производительности

### **Текущие ограничения**
- ✅ **Long polling** - простота развертывания
- ❌ **Нет горизонтального масштабирования**
- ❌ **JSON-хранилище** - ограниченная производительность

### **Рекомендации по масштабированию**
1. **Redis** для кэширования
2. **PostgreSQL** для данных
3. **Webhook режим** для горизонтального масштабирования

## 🚀 Развертывание

### **Production**
```bash
docker-compose up -d
```

### **Preview (для PR)**
```bash
PR_NUM=123 docker-compose -f compose.preview.yml up -d
```

### **Переменные окружения**
```bash
# .env
BOT_TOKEN=your_telegram_bot_token
MAIN_ADMIN_ID=your_admin_id
```

## 🔒 Безопасность

### **Текущие меры**
- Проверка ролей на уровне приложения
- Аудит действий пользователей
- Изоляция через Docker

### **Рекомендации**
- Docker secrets для токенов
- Rate limiting
- Backup стратегия

## 📈 Мониторинг

### **Логирование**
- Структурированные JSON логи
- Аудит действий пользователей
- Ротация логов

### **Health checks**
```dockerfile
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD pgrep -f "python main.py" || exit 1
```

## 💾 Backup

### **Критические данные**
- `/app/data/*.json` - пользователи, заказы, инвентарь
- `/app/logs/` - логи приложения

### **Стратегия**
- Ежедневные снимки volumes
- Резервные копии JSON файлов
- Тестирование восстановления

---

**Заключение:** Проект имеет модульную архитектуру с четким разделением ответственности. Docker обеспечивает изоляцию и простоту развертывания. Основные ограничения связаны с long polling и JSON-хранилищем, что подходит для небольших и средних нагрузок.
