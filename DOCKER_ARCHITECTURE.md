# Архитектура проекта YaEduMerchBot

## Обзор проекта

**YaEduMerchBot** - это Telegram-бот для управления заказами мерча Я.Образования. Бот реализует систему ролей, управление инвентарем, создание и отслеживание заказов через FSM (Finite State Machine).

## Архитектурные компоненты

### 1. Основные модули

#### `main.py` - Точка входа
- Инициализация и запуск бота
- Настройка логирования
- Обработка ошибок запуска

#### `config.py` - Конфигурация
- Управление настройками через Pydantic
- Загрузка переменных окружения
- Конфигурация по умолчанию

#### `src/bot.py` - Основной класс бота
- Инициализация TeleBot
- Регистрация всех обработчиков
- Проверка готовности проекта
- Управление жизненным циклом

### 2. Система авторизации и ролей

#### `src/auth.py` - RoleManager
**Иерархия ролей:**
- **admin** (уровень 4) - полные права
- **coordinator** (уровень 3) - может добавлять промо-пользователей
- **promo** (уровень 2) - может работать с заказами
- **user** (уровень 1) - базовые права

**Функции:**
- Проверка прав доступа
- Управление пользователями
- Инициализация главного админа

### 3. Управление данными

#### `src/storage.py` - JSONStorage
**Особенности:**
- Атомарное сохранение через временные файлы
- Автоматическая инициализация структуры данных
- Поддержка JSON файлов для хранения

**Файлы данных:**
- `users.json` - пользователи и роли
- `chats.json` - активные чаты
- `inventory.json` - инвентарь товаров
- `orders.json` - заказы
- `meta.json` - метаданные (ID заказов)

#### `src/merch_manager.py` - MerchManager
**Функции:**
- Управление типами мерча
- Управление цветами и размерами
- Управление остатками товаров
- Валидация данных

### 4. Управление чатами

#### `src/chat_manager.py` - ChatManager
**Особенности:**
- Одно сообщение на чат (постоянно редактируется)
- Автоматическое обновление контента
- Кэширование сообщений в памяти
- Персистентность через JSON

### 5. Обработчики (Handlers)

#### `src/handlers/merch.py` - Заказы
**FSM состояния:**
- `start` - начало заказа
- `pick_size` - выбор размера
- `pick_color` - выбор цвета
- `await_image` - ожидание фото
- `review` - просмотр заказа
- `pick_chats` - выбор чатов
- `confirm` - подтверждение

#### `src/handlers/admin.py` - Админ-панель
- Управление пользователями
- Настройка проекта
- Мониторинг системы

#### `src/handlers/merch_settings.py` - Настройки мерча
- Управление инвентарем
- Настройка товаров

### 6. Дополнительные компоненты

#### `src/audit_logger.py` - Аудит
- Логирование действий пользователей
- Отслеживание изменений ролей
- История блокировок

#### `src/keyboards.py` - Клавиатуры
- Inline-клавиатуры для навигации
- Динамические меню по ролям

## Docker архитектура

### Образ приложения

**Базовый образ:** `python:3.11-slim`

**Оптимизации:**
- Отключение записи байт-кода Python
- Небуферизованный вывод
- Отключение кэша pip
- Минимальные системные зависимости

### Переменные окружения

```bash
BOT_TOKEN          # Токен Telegram бота
MAIN_ADMIN_ID      # ID главного администратора
DATABASE_URL       # URL базы данных (опционально)
ADMIN_IDS          # Список ID администраторов
PAYMENT_TOKEN      # Токен для платежей
LOG_LEVEL          # Уровень логирования
DEBUG              # Режим отладки
```

### Volumes

- `bot_data:/app/data` - персистентные данные бота
- `./logs:/app/logs` - логи приложения

### Сетевая архитектура

**Особенности:**
- Нет внешних портов (long polling)
- Работа только с Telegram API
- Изоляция от внешней сети

## Развертывание

### Production (compose.yml)
```bash
docker-compose up -d
```

### Preview (compose.preview.yml)
```bash
# Для тестирования PR
PR_NUM=123 docker-compose -f compose.preview.yml up -d
```

## Масштабирование

### Ограничения
- **Один экземпляр бота** на один токен
- **Long polling** не поддерживает горизонтальное масштабирование
- **Webhook режим** потребует дополнительной настройки

### Рекомендации
- Использовать Redis для кэширования
- Мигрировать на PostgreSQL для больших объемов
- Добавить мониторинг и health checks

## Безопасность

### Текущие меры
- Проверка ролей на уровне приложения
- Аудит действий пользователей
- Изоляция данных через Docker volumes

### Рекомендации
- Использовать secrets для токенов
- Добавить rate limiting
- Реализовать backup стратегию

## Мониторинг

### Логирование
- Структурированные логи в JSON
- Ротация логов
- Аудит действий пользователей

### Метрики
- Количество активных пользователей
- Статистика заказов
- Производительность бота

## Резервное копирование

### Данные для backup
- `/app/data/*.json` - все данные пользователей и заказов
- `/app/logs/` - логи приложения

### Стратегия
- Ежедневные снимки volumes
- Резервные копии JSON файлов
- Тестирование восстановления

## Заключение

Проект имеет модульную архитектуру с четким разделением ответственности. Docker-контейнеризация обеспечивает изоляцию и простоту развертывания. Основные ограничения связаны с использованием long polling и JSON-хранилища, что подходит для небольших и средних нагрузок.
